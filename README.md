# MATLAB Structure from Motion (SfM) Project

This project is a MATLAB implementation of a Structure from Motion (SfM) pipeline to reconstruct a 3D scene and camera poses from a sequence of 2D images.

## Overview

The program takes a series of images of a static scene from different viewpoints and produces a sparse 3D point cloud of the scene, along with the estimated camera positions and orientations for each image. This is achieved by finding and matching features between images, estimating the relative motion between camera pairs, and then chaining these transformations together to build a globally consistent 3D model.

## Algorithm Pipeline

The core of the program follows a sequential SfM pipeline. The main steps are:

1.  **Calculate Relative Orientations**: For each consecutive pair of images $(i, i+1)$, we robustly estimate the relative rotation $R_{i,i+1}$ and translation direction $T_{i,i+1}$ between them. This is done by:
    * Detecting and matching SIFT features.
    * Using a RANSAC-based approach with the 8-point algorithm to robustly estimate the Essential Matrix $E$ from the correspondences.
    * Decomposing $E$ to find four possible $(R, T)$ pairs and disambiguating the correct one using the cheirality constraint (ensuring reconstructed points are in front of both cameras).

2.  **Upgrade to Absolute Rotations**: The relative rotations are chained together to compute the absolute orientation $R_i$ for each camera with respect to the first camera's coordinate frame, which is set as the world frame.
    * Set $R_1 = I$.
    * Compute $R_i = R_{i-1,i} R_{i-1}$ for $i = 2, 3, ...$

3.  **Reconstruct Initial 3D Points**: An initial set of 3D points is reconstructed from a well-separated initial image pair $(i_1, i_2)$.
    * The relative pose $(R_{i_2,i_1}, T_{i_2,i_1})$ is computed.
    * Inlier feature matches between this pair are triangulated to create an initial 3D point cloud, $\mathcal{X}_0$.
    * The SIFT descriptors for these 3D points are stored for later matching.

4.  **Robustly Calculate Camera Centers (Resectioning)**: For each subsequent image $i$, its camera center $C_i$ (or translation $T_i$) is determined.
    * 2D-3D correspondences are established by matching the SIFT features in image $i$ with the stored descriptors of the existing 3D points $\mathcal{X}_0$.
    * The camera center $C_i$ is estimated robustly using a RANSAC loop. The minimal solver for this step uses 2 correspondences to solve for the translation, as the rotation $R_i$ is already known.

5.  **Refine Camera Centers**: The estimated camera centers are refined using the Levenberg-Marquardt algorithm to minimize the reprojection error.

6.  **Triangulate and Visualize**: Once all camera poses are determined, the final 3D point cloud is generated by triangulating the matched features from all consecutive image pairs. The final output is a visualization of the reconstructed 3D points and the camera poses.

## Key Implementation Details

* **RANSAC for Relative Pose**: A robust RANSAC algorithm is implemented to estimate the Essential Matrix from feature correspondences. It iteratively samples 8 correspondences, computes $E$, and finds the model with the maximum number of inliers.
* **Translation Estimation (Resectioning)**: To find the camera translation for a new view given 2D-3D matches, a custom RANSAC loop is used. The minimal solver takes 2 correspondences and the known camera rotation $R_i$ to solve for the translation vector $T_i$.
* **Data Normalization**: All image points are normalized by the camera intrinsic matrix $K$ before any geometric calculations to improve numerical stability. Thresholds for RANSAC are also adjusted to this normalized scale.

## How to Run the Program

To run the full SfM pipeline on a given dataset, use the main script from the MATLAB command window:

```
>> run_sfm(<dataset_number>)
```

Where `<dataset_number>` is an integer corresponding to one of the provided datasets (e.g., 3, 4, 5, 6, 7).

### Dependencies

* **[VLFeat Toolbox](https://www.vlfeat.org/)**: This project requires the VLFeat toolbox for SIFT feature detection and matching. Ensure that the toolbox is properly set up before running the code. The script will attempt to set it up automatically.

### Datasets

The program is designed to work with the provided datasets. Information for each dataset (camera intrinsics, image names, initial pair) is loaded using the `get_dataset_info` function.

* **Datasets 1 & 2**: Simple datasets for initial debugging.
* **Datasets 3-7**: Main datasets of increasing difficulty for evaluation.

The results, including the final 3D plot, will be generated upon successful completion of the script.
